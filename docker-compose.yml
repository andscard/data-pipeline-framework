# docker-compose.yml
# Configuración inicial de infraestructura - Paso 2

version: '3.8'

services:
    # ============================================
    # PostgreSQL - Base de datos principal
    # ============================================
    postgres:
        image: postgres:15.4
        container_name: framework_postgres
        environment:
            POSTGRES_DB: ${POSTGRES_DB:-pipeline_db}
            POSTGRES_USER: ${POSTGRES_USER:-admin}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-secret_password}
            POSTGRES_INITDB_ARGS: '-E UTF8 --locale=en_US.UTF-8'
            # Configuración de performance
            POSTGRES_MAX_CONNECTIONS: 100
            POSTGRES_SHARED_BUFFERS: 256MB
        ports:
            - '5440:5432'
        volumes:
            # Persistencia de datos
            - postgres_data:/var/lib/postgresql/data
            # Scripts de inicialización
            - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/init.sql
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'pg_isready -U ${POSTGRES_USER:-admin} -d ${POSTGRES_DB:-pipeline_db}',
                ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        networks:
            - framework_network
        restart: unless-stopped

    # ============================================
    # Redis - Caché y Message Broker
    # ============================================
    redis:
        image: redis:7.2.3-alpine
        container_name: framework_redis
        command: >
            redis-server 
            --appendonly yes 
            --requirepass ${REDIS_PASSWORD:-redis_secret}
            --maxmemory 256mb
            --maxmemory-policy allkeys-lru
        ports:
            - '7000:6379'
        volumes:
            # Persistencia de datos
            - redis_data:/data
        healthcheck:
            test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 5s
        networks:
            - framework_network
        restart: unless-stopped

    # ============================================
    # Adminer - UI para administrar PostgreSQL (opcional pero útil)
    # ============================================
    adminer:
        image: adminer:latest
        container_name: framework_adminer
        environment:
            ADMINER_DEFAULT_SERVER: postgres
        ports:
            - '8081:8080'
        networks:
            - framework_network
        restart: unless-stopped
        depends_on:
            postgres:
                condition: service_healthy

    # ============================================
    # RedisInsight - UI para administrar Redis (opcional)
    # ============================================
    redis-insight:
        image: redislabs/redisinsight:latest
        container_name: framework_redis_insight
        ports:
            - '8001:5540'
        volumes:
            - redis_insight_data:/db
        networks:
            - framework_network
        restart: unless-stopped
        depends_on:
            redis:
                condition: service_healthy

# ============================================
# Volúmenes persistentes
# ============================================
volumes:
    postgres_data:
        driver: local
        name: framework_postgres_data
    redis_data:
        driver: local
        name: framework_redis_data
    redis_insight_data:
        driver: local
        name: framework_redis_insight_data

# ============================================
# Red interna
# ============================================
networks:
    framework_network:
        driver: bridge
        name: framework_network
